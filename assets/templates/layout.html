<!DOCTYPE html>
<html lang="en" dir="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="file-path" content="{{ file_path }}">
    <title>{{ title }}</title>
    {% if theme == "auto" %}
    <link rel="stylesheet" href="/static/css/github-markdown-light.css" media="(prefers-color-scheme: light)">
    <link rel="stylesheet" href="/static/css/github-markdown-dark.css" media="(prefers-color-scheme: dark)">
    {% else %}
    <link rel="stylesheet" href="/static/css/github-markdown-{{ theme }}.css">
    {% endif %}
    <link rel="stylesheet" href="/static/css/github-print.css" media="print">
    <link rel="stylesheet" href="/static/css/editor.css">
    <style>
        body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
        }

        a:visited {
            color: inherit;
        }

        {% if theme == "dark" %}
        body {
            background-color: #0d1117;
            color: #f0f6fc;
        }
        {% elif theme == "light" %}
        body {
            background-color: #ffffff;
            color: #1f2328;
        }
        {% else %}
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #0d1117;
                color: #f0f6fc;
            }
        }
        @media (prefers-color-scheme: light) {
            body {
                background-color: #ffffff;
                color: #1f2328;
            }
        }
        {% endif %}

        .back-link {
            margin-bottom: 20px;
            display: block;
        }

        .back-link a {
            color: #0969da;
            text-decoration: none;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        {% if theme == "dark" %}
        .back-link a {
            color: #58a6ff;
        }
        {% endif %}

        .footer {
            margin-top: 10px;
            padding-top: 20px;
            font-size: 0.9rem;
            text-align: left;
            margin-left: -1px;
        }

        .footer a {
            text-decoration: none;
            color: #8b949e;
        }

        .footer a:visited {
            color: #8b949e;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .footer-separator {
            color: #8b949e;
            margin: 0 8px;
        }

        .footer-clear-link {
            color: #8b949e;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .footer-clear-link:visited {
            color: #8b949e;
        }

        .footer-clear-link:hover {
            color: #dc3545;
            text-decoration: underline;
        }

        {% if theme == "dark" %}
        .footer {
            color: #8b949e;
        }
        .footer a,
        .footer a:visited {
            color: #8b949e;
        }
        {% elif theme == "light" %}
        .footer {
            color: #656d76;
        }
        .footer a,
        .footer a:visited {
            color: #656d76;
        }
        {% else %}
        @media (prefers-color-scheme: dark) {
            .footer {
                color: #8b949e;
            }
            .footer a,
            .footer a:visited {
                color: #8b949e;
            }
        }
        @media (prefers-color-scheme: light) {
            .footer {
                color: #656d76;
            }
            .footer a,
            .footer a:visited {
                color: #656d76;
            }
        }
        {% endif %}

        @media print {
            .back-link {
                display: none;
            }
            .toc {
                display: none;
            }
        }

        /* Table of Contents Styles */
        .toc {
            padding: 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .toc-title {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .toc-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .toc-item {
            margin: 4px 0;
        }

        .toc-item a {
            text-decoration: none;
            display: block;
            padding: 2px 0;
            transition: all 0.2s;
        }

        .toc-item a:hover {
            text-decoration: underline;
        }

        .toc-item a.active {
            font-weight: 600;
        }

        /* Indent based on heading level */
        .toc-level-1 { padding-left: 0; }
        .toc-level-2 { padding-left: 12px; }
        .toc-level-3 { padding-left: 24px; }
        .toc-level-4 { padding-left: 36px; }
        .toc-level-5 { padding-left: 48px; }
        .toc-level-6 { padding-left: 60px; }

        /* Desktop: Fixed left sidebar */
        @media (min-width: 1281px) {
            .toc {
                position: fixed;
                left: 20px;
                top: 20px;
                max-width: 250px;
                max-height: calc(100vh - 40px);
                overflow-y: auto;
            }
        }

        /* Mobile/Tablet: Top of page */
        @media (max-width: 1280px) {
            .toc {
                position: relative;
                margin-bottom: 30px;
                max-width: 100%;
            }
        }

        {% if theme == "dark" %}
        .toc-title {
            color: #f0f6fc;
        }
        .toc-item a {
            color: #8b949e;
        }
        .toc-item a:hover {
            color: #58a6ff;
        }
        .toc-item a.active {
            color: #58a6ff;
            background-color: rgba(88, 166, 255, 0.15);
            border-radius: 4px;
            padding: 2px 6px;
        }
        {% elif theme == "light" %}
        .toc-title {
            color: #1f2328;
        }
        .toc-item a {
            color: #656d76;
        }
        .toc-item a:hover {
            color: #0969da;
        }
        .toc-item a.active {
            color: #0969da;
            background-color: rgba(9, 105, 218, 0.1);
            border-radius: 4px;
            padding: 2px 6px;
        }
        {% else %}
        @media (prefers-color-scheme: dark) {
            .toc-title {
                color: #f0f6fc;
            }
            .toc-item a {
                color: #8b949e;
            }
            .toc-item a:hover {
                color: #58a6ff;
            }
            .toc-item a.active {
                color: #58a6ff;
                background-color: rgba(88, 166, 255, 0.15);
                border-radius: 4px;
                padding: 2px 6px;
            }
        }
        @media (prefers-color-scheme: light) {
            .toc-title {
                color: #1f2328;
            }
            .toc-item a {
                color: #656d76;
            }
            .toc-item a:hover {
                color: #0969da;
            }
            .toc-item a.active {
                color: #0969da;
                background-color: rgba(9, 105, 218, 0.1);
                border-radius: 4px;
                padding: 2px 6px;
            }
        }
        {% endif %}

        /* Dark mode support for all panels */
        {% if theme == "dark" %}
        /* Selection popover */
        .selection-popover {
            background-color: #21262d;
            color: #f0f6fc;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        .selection-popover button {
            color: #f0f6fc;
        }
        .selection-popover button:hover {
            background-color: #30363d;
        }
        .popover-separator {
            color: #484f58;
        }

        /* Note input modal */
        .note-input-modal {
            background: #161b22;
            border: 1px solid #30363d;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        .note-textarea {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #f0f6fc;
        }
        .note-textarea:focus {
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }
        .note-input-actions button {
            background: #21262d;
            border: 1px solid #30363d;
            color: #f0f6fc;
        }
        .note-input-actions button:hover {
            background: #30363d;
        }
        .note-save {
            background: #238636 !important;
            border-color: #238636 !important;
        }
        .note-save:hover {
            background: #2ea043 !important;
        }

        /* Note cards */
        .note-card-margin {
            background: #161b22;
            border-left: 3px solid #58a6ff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .note-card-margin:hover {
            background: #1c2128;
            border-left-color: #58a6ff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }
        .note-card-margin.highlight-active {
            border: 2px solid #58a6ff;
            border-left: 3px solid #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }
        .note-content {
            color: #f0f6fc;
        }

        /* Confirm dialog */
        .confirm-dialog {
            background: #161b22;
            border: 1px solid #30363d;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        .confirm-message {
            color: #f0f6fc;
        }
        .confirm-actions button {
            background: #21262d;
            border: 1px solid #30363d;
            color: #f0f6fc;
        }
        .confirm-actions button:hover {
            background: #30363d;
        }

        /* Note popup */
        .note-popup {
            background: #161b22;
            border: 1px solid #58a6ff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* Has-note highlight */
        .has-note {
            background-color: rgba(187, 128, 9, 0.15);
            border-bottom: 2px dotted rgba(187, 128, 9, 0.4);
        }
        .has-note:hover {
            background-color: rgba(187, 128, 9, 0.25);
            border-bottom-color: rgba(187, 128, 9, 0.6);
        }
        .has-note.highlight-active {
            background-color: rgba(88, 166, 255, 0.15);
            border-bottom: 2px solid #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.15);
        }

        /* Highlight colors for dark mode */
        .highlight-orange {
            background-color: rgba(187, 128, 9, 0.3);
        }
        .highlight-green {
            background-color: rgba(46, 160, 67, 0.25);
        }
        .highlight-yellow {
            background-color: rgba(187, 128, 9, 0.25);
        }

        /* Link colors in markdown body */
        .markdown-body a:link,
        .markdown-body a:visited,
        .markdown-body a:hover,
        .markdown-body a:active,
        .markdown-body a:focus {
            color: #58a6ff !important;
        }

        {% else %}
        @media (prefers-color-scheme: dark) {
            /* Selection popover */
            .selection-popover {
                background-color: #21262d;
                color: #f0f6fc;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }
            .selection-popover button {
                color: #f0f6fc;
            }
            .selection-popover button:hover {
                background-color: #30363d;
            }
            .popover-separator {
                color: #484f58;
            }

            /* Note input modal */
            .note-input-modal {
                background: #161b22;
                border: 1px solid #30363d;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }
            .note-textarea {
                background: #0d1117;
                border: 1px solid #30363d;
                color: #f0f6fc;
            }
            .note-textarea:focus {
                border-color: #58a6ff;
                box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
            }
            .note-input-actions button {
                background: #21262d;
                border: 1px solid #30363d;
                color: #f0f6fc;
            }
            .note-input-actions button:hover {
                background: #30363d;
            }
            .note-save {
                background: #238636 !important;
                border-color: #238636 !important;
            }
            .note-save:hover {
                background: #2ea043 !important;
            }

            /* Note cards */
            .note-card-margin {
                background: #161b22;
                border-left: 3px solid #58a6ff;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            }
            .note-card-margin:hover {
                background: #1c2128;
                border-left-color: #58a6ff;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            }
            .note-card-margin.highlight-active {
                border: 2px solid #58a6ff;
                border-left: 3px solid #58a6ff;
                box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
            }
            .note-content {
                color: #f0f6fc;
            }

            /* Confirm dialog */
            .confirm-dialog {
                background: #161b22;
                border: 1px solid #30363d;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }
            .confirm-message {
                color: #f0f6fc;
            }
            .confirm-actions button {
                background: #21262d;
                border: 1px solid #30363d;
                color: #f0f6fc;
            }
            .confirm-actions button:hover {
                background: #30363d;
            }

            /* Note popup */
            .note-popup {
                background: #161b22;
                border: 1px solid #58a6ff;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            }

            /* Has-note highlight */
            .has-note {
                background-color: rgba(187, 128, 9, 0.15);
                border-bottom: 2px dotted rgba(187, 128, 9, 0.4);
            }
            .has-note:hover {
                background-color: rgba(187, 128, 9, 0.25);
                border-bottom-color: rgba(187, 128, 9, 0.6);
            }
            .has-note.highlight-active {
                background-color: rgba(88, 166, 255, 0.15);
                border-bottom: 2px solid #58a6ff;
                box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.15);
            }

            /* Highlight colors for dark mode */
            .highlight-orange {
                background-color: rgba(187, 128, 9, 0.3);
            }
            .highlight-green {
                background-color: rgba(46, 160, 67, 0.25);
            }
            .highlight-yellow {
                background-color: rgba(187, 128, 9, 0.25);
            }

            /* Link colors in markdown body */
            .markdown-body a:link,
            .markdown-body a:visited,
            .markdown-body a:hover,
            .markdown-body a:active,
            .markdown-body a:focus {
                color: #58a6ff !important;
            }
        }
        {% endif %}
    </style>
</head>
<body>
    <article class="markdown-body">
        {% if show_back_link %}
        <div class="back-link">
            <a href="/">← Back to file list</a>
        </div>
        {% endif %}
        <div id="notes-sidebar"></div>
        {% if toc and toc | length > 0 %}
        <nav class="toc">
            <div class="toc-title">Table of Contents</div>
            <ul class="toc-list">
                {% for item in toc %}
                <li class="toc-item toc-level-{{ item.level }}">
                    <a href="#{{ item.id }}">{{ item.text }}</a>
                </li>
                {% endfor %}
            </ul>
        </nav>
        {% endif %}
        {{ content | safe }}
    </article>
    <footer class="container footer">
        <a href="https://github.com/kookyleo/markon">(L) Generated by AI, Gently approved by kookyleo 👀</a>
        <span class="footer-separator"> | </span>
        <a href="#" class="footer-clear-link" onclick="clearPageAnnotations(event); return false;">Clear Annotations</a>
    </footer>
    {% if has_mermaid %}
    <script src="/static/js/mermaid.min.js"></script>
    <script>
        {% if theme == "dark" %}
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });
        {% elif theme == "light" %}
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
        {% else %}
        // Auto theme
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            mermaid.initialize({ startOnLoad: true, theme: 'dark' });
        } else {
            mermaid.initialize({ startOnLoad: true, theme: 'default' });
        }
        {% endif %}
    </script>
    {% endif %}
    <script src="/static/js/editor.js"></script>
    <script>
        // TOC active item tracking with Intersection Observer
        (function() {
            const toc = document.querySelector('.toc');
            if (!toc) return;

            const tocLinks = toc.querySelectorAll('.toc-item a');
            if (tocLinks.length === 0) return;

            // Get all heading elements that have IDs
            const headings = Array.from(document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]'));
            if (headings.length === 0) return;

            // Track visible headings
            const visibleHeadings = new Set();
            let isUserClicking = false;
            let clickedTargetId = null;

            // Helper to update active state
            function setActiveLink(targetId) {
                tocLinks.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href === '#' + targetId) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
            }

            // Intersection Observer to detect visible headings
            const observer = new IntersectionObserver((entries) => {
                // During click, ignore observer updates
                if (isUserClicking) return;

                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        visibleHeadings.add(entry.target);
                    } else {
                        visibleHeadings.delete(entry.target);
                    }
                });

                // Find the first visible heading (topmost)
                let activeHeading = null;
                for (const heading of headings) {
                    if (visibleHeadings.has(heading)) {
                        activeHeading = heading;
                        break;
                    }
                }

                // Update active class
                if (activeHeading) {
                    setActiveLink(activeHeading.id);
                }
            }, {
                rootMargin: '0px 0px -85% 0px',
                threshold: [0, 0.25, 0.5, 0.75, 1.0]
            });

            // Observe all headings
            headings.forEach(heading => observer.observe(heading));

            // Ensure TOC clicks are instant (no smooth scroll)
            tocLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const href = link.getAttribute('href');
                    if (href && href.startsWith('#')) {
                        e.preventDefault();
                        const targetId = href.substring(1);
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            // Lock observer updates
                            isUserClicking = true;
                            clickedTargetId = targetId;

                            // Clear visible headings to prevent stale state
                            visibleHeadings.clear();

                            // Immediately update active state
                            setActiveLink(targetId);

                            // Direct jump, no animation
                            window.scrollTo({
                                top: targetElement.offsetTop - 20,
                                behavior: 'auto'
                            });
                            history.pushState(null, '', href);

                            // After scroll, manually update visible headings and unlock
                            requestAnimationFrame(() => {
                                requestAnimationFrame(() => {
                                    // Double RAF to ensure layout is complete
                                    // Manually check which headings are now visible
                                    const viewportTop = window.scrollY;
                                    const viewportBottom = viewportTop + window.innerHeight * 0.15;

                                    headings.forEach(heading => {
                                        const headingTop = heading.offsetTop;
                                        if (headingTop >= viewportTop && headingTop <= viewportBottom) {
                                            visibleHeadings.add(heading);
                                        }
                                    });

                                    // Unlock observer
                                    isUserClicking = false;
                                    clickedTargetId = null;
                                });
                            });
                        }
                    }
                });
            });
        })();
    </script>
</body>
</html>
